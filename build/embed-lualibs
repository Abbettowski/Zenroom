#!/usr/bin/env zsh

# script to take all extensions in src/lua and embed them inside
# zenroom as strings

[[ -d src/lua ]] || {
	print "error - directory not found: src/lua"
	return 1
}


cat <<EOF > src/lualibs_detected.c
// This file is generated by running build/embed-lualibs
#include <lua.h>
#include <lua_functions.h>


EOF
libs=`find src/lua -type f -name '*.lua'`
# for i in ${(f)libs}; do
# 	p=`basename $i`
# 	n=${p[(ws:.:)1]}
# 	print "#include <lualib_$n.c>" >> src/lualibs_detected.c
# done

extarray=()
c=0
for i in ${(f)libs}; do
	p=`basename $i`
	n=${p[(ws:.:)1]}
	f="lualib_${n}.c"
	print "+ $i"
	tmp=`mktemp -d`
	./build/luac -o ${tmp}/${n} $i
	pwd=`pwd`
	pushd $tmp
	print         >> ${pwd}/src/lualibs_detected.c
	print "// $i" >> ${pwd}/src/lualibs_detected.c
	xxd -i ${n}   >> ${pwd}/src/lualibs_detected.c
	print         >> ${pwd}/src/lualibs_detected.c
	popd
	rm -rf $tmp
	extarray+=("{\"${n}\", &${n}_len, (const char *)${n}},")
	c=$(( c + 1 ))
done


cat <<EOF >> src/lualibs_detected.c
zen_extension_t zen_extensions[] = {
EOF
for i in $extarray; do
	print "$i" >> lualibs_detected.c
done
cat <<EOF >> src/lualibs_detected.c
    { NULL, NULL, NULL }
};
EOF
